// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  password  String
  phone     String?
  role      String
  crm       String?
  createdAt DateTime @default(now())

  appointmentsAsDoctor Appointment[]
  stockMovements       StockMovement[]
  sentMessages         ChatMessage[]   @relation("Sender")
  receivedMessages     ChatMessage[]   @relation("Receiver")

  // --- LINHAS NOVAS PARA O FINANCEIRO ---
  budgets      Budget[]      // Orçamentos que este usuário criou
  transactions Transaction[] // Lançamentos que este usuário registrou
}

model Patient {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?  @unique
  phone     String?
  createdAt DateTime @default(now())

  appointments Appointment[]

  // --- LINHAS NOVAS PARA O FINANCEIRO ---
  budgets      Budget[]      // Orçamentos deste paciente
  transactions Transaction[] // Transações deste paciente
}

model Appointment {
  id        Int      @id @default(autoincrement())
  date      DateTime
  status    String
  patientId Int
  doctorId  Int
  doctor    User     @relation(fields: [doctorId], references: [id])
  patient   Patient  @relation(fields: [patientId], references: [id])
}

// --- Modelos de Estoque (Existentes) ---
model Product {
  id            Int      @id @default(autoincrement())
  name          String
  description   String?
  sku           String   @unique
  category      String?
  unitMeasure   String
  minStockLevel Int      @default(0)
  location      String?
  controlsLot   Boolean  @default(true)
  controlsExpiry Boolean  @default(true)
  lots          StockLot[]
  movements     StockMovement[]
}

model StockLot {
  id              Int             @id @default(autoincrement())
  lotNumber       String
  expiryDate      DateTime?
  initialQuantity Int
  currentQuantity Int
  entryDate       DateTime        @default(now())
  productId       Int
  product         Product         @relation(fields: [productId], references: [id])
  movements       StockMovement[]
}

model StockMovement {
  id         Int          @id @default(autoincrement())
  type       MovementType
  quantity   Int
  date       DateTime     @default(now())
  reason     String?
  productId  Int
  product    Product      @relation(fields: [productId], references: [id], onDelete: Restrict)
  stockLotId Int
  stockLot   StockLot     @relation(fields: [stockLotId], references: [id], onDelete: Restrict)
  userId     Int
  user       User         @relation(fields: [userId], references: [id])
}

enum MovementType {
  ENTRY
  EXIT
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  senderId  Int
  sender    User     @relation("Sender", fields: [senderId], references: [id])
  receiverId Int
  receiver  User     @relation("Receiver", fields: [receiverId], references: [id])
  @@index([senderId])
  @@index([receiverId])
}

// ----------------------------------------------
// --- NOVOS MODELS PARA O MÓDULO FINANCEIRO ---
// ----------------------------------------------

// Catálogo de Serviços/Procedimentos
model Service {
  id    Int     @id @default(autoincrement())
  name  String  @unique // Ex: "Consulta", "Ecocardiograma"
  price Float   // Preço padrão
  
  // Relacionamentos
  transactions Transaction[]
  budgets      BudgetLine[]
}

// Convênios
model Convenio {
  id   Int    @id @default(autoincrement())
  name String @unique // Ex: "Unimed", "Bradesco Saúde"
  
  // Relacionamentos
  transactions Transaction[]
}

// Orçamentos
model Budget {
  id        Int      @id @default(autoincrement())
  patientId Int
  patient   Patient  @relation(fields: [patientId], references: [id])
  userId    Int
  user      User     @relation(fields: [userId], references: [id]) // Quem criou
  date      DateTime @default(now())
  total     Float
  status    String   // Ex: "Pendente", "Aprovado"
  
  lines BudgetLine[] // Linhas do orçamento
}

// Linhas de um Orçamento
model BudgetLine {
  id        Int     @id @default(autoincrement())
  budgetId  Int
  budget    Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  serviceId Int
  service   Service @relation(fields: [serviceId], references: [id])
  quantity  Int
  unitPrice Float
}

// O "Livro Caixa" (Receitas e Despesas)
model Transaction {
  id            Int      @id @default(autoincrement())
  date          DateTime @default(now())
  description   String
  amount        Float    // Valor (positivo para Receita, negativo para Despesa)
  type          String   // "RECEITA" ou "DESPESA"
  paymentMethod String   // "Pix", "Cartão", "Dinheiro", "Convênio"
  status        String   // "Pago" ou "Pendente" (para Contas a Pagar/Receber)

  // Relacionamentos
  patientId Int?
  patient   Patient? @relation(fields: [patientId], references: [id])
  
  convenioId Int?
  convenio   Convenio? @relation(fields: [convenioId], references: [id])

  serviceId Int?
  service   Service? @relation(fields: [serviceId], references: [id])

  // Quem registrou a transação
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
}