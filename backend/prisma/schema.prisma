generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int           @id @default(autoincrement())
  email                String        @unique
  name                 String
  password             String
  phone                String?
  role                 String
  crm                  String?
  createdAt            DateTime      @default(now())
  appointmentsAsDoctor Appointment[]
  stockMovements       StockMovement[]
  sentMessages         ChatMessage[] @relation("Sender")
  receivedMessages     ChatMessage[] @relation("Receiver")
  budgets              Budget[]
  transactions         Transaction[]
  logs SystemLog[]
}

model Patient {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?  @unique
  phone     String?
  createdAt DateTime @default(now())

  // --- NOVOS CAMPOS ADICIONADOS ---
  cpf        String?   @unique
  birthDate  DateTime?
  gender     String?
  address    String?

  // Relação com Convênio
  convenioId Int?
  convenio   Convenio? @relation(fields: [convenioId], references: [id])
  // --- FIM DOS NOVOS CAMPOS ---

  appointments Appointment[]
  budgets      Budget[]
  transactions Transaction[]
}

model Appointment {
  id        Int      @id @default(autoincrement())
  date      DateTime
  status    String
  patientId Int
  doctorId  Int
  doctor    User     @relation(fields: [doctorId], references: [id])
  patient   Patient  @relation(fields: [patientId], references: [id])
  serviceId Int?
  service   Service? @relation(fields: [serviceId], references: [id])

  // --- MUDANÇA AQUI: Relacionamento com os anexos ---
  attachments Attachment[] 
}

// --- Modelos de Estoque (Existentes) ---
model Product {
  id             Int             @id @default(autoincrement())
  name           String
  description    String?
  sku            String          @unique
  category       String?
  unitMeasure    String
  minStockLevel  Int             @default(0)
  location       String?
  controlsLot    Boolean         @default(true)
  controlsExpiry Boolean         @default(true)
  lots           StockLot[]
  movements      StockMovement[]
}

model StockLot {
  id              Int             @id @default(autoincrement())
  lotNumber       String
  expiryDate      DateTime?
  initialQuantity Int
  currentQuantity Int
  entryDate       DateTime        @default(now())
  productId       Int
  product         Product         @relation(fields: [productId], references: [id])
  movements       StockMovement[]
}

model StockMovement {
  id         Int          @id @default(autoincrement())
  type       MovementType
  quantity   Int
  date       DateTime     @default(now())
  reason     String?
  productId  Int
  product    Product      @relation(fields: [productId], references: [id], onDelete: Restrict)
  stockLotId Int
  stockLot   StockLot     @relation(fields: [stockLotId], references: [id], onDelete: Restrict)
  userId     Int
  user       User         @relation(fields: [userId], references: [id])
}

enum MovementType {
  ENTRY
  EXIT
}

model ChatMessage {
  id         Int      @id @default(autoincrement())
  content    String
  createdAt  DateTime @default(now())
  senderId   Int
  sender     User     @relation("Sender", fields: [senderId], references: [id])
  receiverId Int
  receiver   User     @relation("Receiver", fields: [receiverId], references: [id])
  @@index([senderId])
  @@index([receiverId])
}

// --- Modelos Financeiros ---
model Service {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  description  String?
  price        Float
  transactions Transaction[]
  budgets      BudgetLine[]
  appointments Appointment[]
}

model Convenio {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  transactions Transaction[]
  patients     Patient[]
}

model Budget {
  id        Int          @id @default(autoincrement())
  patientId Int
  patient   Patient      @relation(fields: [patientId], references: [id])
  userId    Int
  user      User         @relation(fields: [userId], references: [id])
  date      DateTime     @default(now())
  total     Float
  status    String
  lines     BudgetLine[]
}

model BudgetLine {
  id        Int     @id @default(autoincrement())
  budgetId  Int
  budget    Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  serviceId Int
  service   Service @relation(fields: [serviceId], references: [id])
  quantity  Int
  unitPrice Float
}

model Transaction {
  id            Int       @id @default(autoincrement())
  date          DateTime  @default(now())
  description   String
  amount        Float
  type          String
  paymentMethod String
  status        String
  patientId     Int?
  patient       Patient?  @relation(fields: [patientId], references: [id])
  convenioId    Int?
  convenio      Convenio? @relation(fields: [convenioId], references: [id])
  serviceId     Int?
  service       Service?  @relation(fields: [serviceId], references: [id])
  userId        Int
  user          User      @relation(fields: [userId], references: [id])
}

// --- NOVO MODELO DE ANEXOS (EXAMES) ---
model Attachment {
  id            Int         @id @default(autoincrement())
  fileName      String      // Nome original (ex: hemograma.pdf)
  filePath      String      // Nome salvo no disco (ex: 1740000-hemograma.pdf)
  createdAt     DateTime    @default(now())
  
  appointmentId Int
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
}

model SystemLog {
  id        Int      @id @default(autoincrement())
  action    String   // Ex: "Agendou Consulta", "Adicionou Produto"
  details   String?  // Ex: "Paciente: João, Data: 20/11"
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
}